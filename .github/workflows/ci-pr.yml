name: CI - Pull Request

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.java'
      - '**/pom.xml'
      - 'consumer-service/**'
      - 'producer-service/**'
      - '.github/workflows/**'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [consumer-service, producer-service]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Build ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          mvn clean compile -B
      
      - name: Run tests for ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          mvn test -B
      
      - name: Package ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          mvn package -DskipTests -B
      
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.service }}-jar
          path: ${{ matrix.service }}/target/*.jar
          retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Run Maven verify
        run: |
          for service in consumer-service producer-service; do
            cd $service
            mvn verify -DskipTests -B
            cd ..
          done

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: build-and-test
    
    strategy:
      matrix:
        service: [consumer-service, producer-service]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image for ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}
          push: false
          tags: ${{ matrix.service }}:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Start Docker Compose
        run: |
          docker compose up -d kafka
          # Give the container a moment to actually start the process
          sleep 10 

      - name: Wait for Kafka KRaft
        run: |
          # Increased timeout to 90s for KRaft election
          # We use --bootstrap-server kafka:9092 because we are 'exec-ing' INSIDE the network
          timeout 90 bash -c '
          until docker compose exec kafka kafka-topics --bootstrap-server kafka:9092 --list; do
            echo "Waiting for KRaft controller election..."
            sleep 5
          done'

      - name: Run integration tests
        run: |
          for service in consumer-service producer-service; do
            cd $service
            # Ensure tests point to the Docker-exposed port if necessary
            mvn verify -B
            cd ..
          done

      - name: Stop Docker Compose
        if: always()
        run: docker compose down -v


  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, docker-build-test]
    if: always()
    
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.build-and-test.result }}" != "success" ] || \
             [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.docker-build-test.result }}" != "success" ]; then
            echo "❌ One or more checks failed"
            exit 1
          else
            echo "✅ All checks passed"
          fi
